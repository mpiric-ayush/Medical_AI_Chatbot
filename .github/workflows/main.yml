name: CI/CD for Smart Gallery

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'  # Matches your project

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest  # If not in requirements.txt

      - name: Run tests
        run: pytest tests/  # Runs all tests in tests/ folder
        env:
          # Optional: Set env vars for tests, e.g., paths to sample data
          TEST_GALLERY_PATH: ./assets/sample_images

  build-apk:
    runs-on: ubuntu-latest
    needs: test  # Only build if tests pass
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Buildozer and dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential ccache git zlib1g-dev python3 python3-dev libncurses5-dev libzmq3-dev libjpeg-dev openjdk-17-jdk
          python -m pip install --upgrade pip cython buildozer

      - name: Build APK
        run: buildozer -v android debug  # Builds the debug APK; use 'release' for signed if keys are set

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: smart-gallery-apk
          path: bin/*.apk  # Uploads the built APK for download

  deploy:
    runs-on: ubuntu-latest
    needs: build-apk  # Only deploy if build succeeds
    if: github.ref == 'refs/heads/main'  # Only on push to main (CD part)
    steps:
      - name: Download APK artifact
        uses: actions/download-artifact@v4
        with:
          name: smart-gallery-apk
          path: bin/

      # Optional: Deploy to Firebase App Distribution (add if needed)
      # - name: Deploy to Firebase
      #   uses: w9jds/firebase-action@master
      #   with:
      #     args: appdistribution:distribute bin/*.apk --app YOUR_FIREBASE_APP_ID --groups testers
      #   env:
      #     FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}

      # Optional: Deploy to Google Play (requires fastlane or similar; advanced)
      # Add steps here if you set up signing keys as secrets.
